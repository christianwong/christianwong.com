name: Deploy release

on:
  release:
    types: [released]

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - name: tag number
        run : echo ${{ github.event.release.tag_name }}
      - name: Checkout Repo
        uses: actions/checkout@master
      - name: Replace GITHUB_SERVER_URL
        uses: shitiomatic/str-replace@master
        with:
          find: "##GITHUB_SERVER_URL##"
          replace: $GITHUB_SERVER_URL
          include: "src/"
      - name: Replace GITHUB_REPOSITORY
        uses: shitiomatic/str-replace@master
        with:
          find: "##GITHUB_REPOSITORY##"
          replace: $GITHUB_REPOSITORY
          include: "src/"
      - name: Replace RELEASE_TAG_NAME
        uses: shitiomatic/str-replace@master
        with:
          find: "##RELEASE_TAG_NAME##"
          replace: ${{ github.event.release.tag_name }}
          include: "src/"
      - name: Install Dependencies
        run: yarn
      - name: Run Tests
        env:
          CI: true
        run: yarn test
      - name: Build
        run: yarn build
      - name: Archive Production Artifact
        uses: actions/upload-artifact@master
        with:
          name: build
          path: build

  deploy:
    name: Deploy
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@master
      - name: Download Artifact
        uses: actions/download-artifact@master
        with:
          name: build
          path: build
      - name: Deploy to Firebase
        uses: w9jds/firebase-action@master
        with:
          args: deploy --only hosting --project ${{ secrets.PROJECT_ID }}
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
